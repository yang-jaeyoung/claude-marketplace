# Rails 8 Default Dockerfile (Multi-stage Build)

## Overview

This is the Rails 8 default Dockerfile optimized for production. It uses multi-stage builds to minimize image size and includes security best practices.

## When to Use

- When deploying with Kamal
- When containerizing Rails applications
- As a starting point for custom Dockerfiles

## Quick Start

```dockerfile
# Dockerfile - Rails 8 Default (Generated by `rails new`)
ARG RUBY_VERSION=3.3.0
FROM ruby:$RUBY_VERSION-slim AS base

# Rails app lives here
WORKDIR /rails

# Set production environment
ENV RAILS_ENV="production" \
    BUNDLE_DEPLOYMENT="1" \
    BUNDLE_PATH="/usr/local/bundle" \
    BUNDLE_WITHOUT="development:test"

# Throw-away build stage to reduce size of final image
FROM base AS build

# Install packages needed to build gems
RUN apt-get update -qq && \
    apt-get install --no-install-recommends -y \
    build-essential \
    git \
    libpq-dev \
    pkg-config

# Install application gems
COPY Gemfile Gemfile.lock ./
RUN bundle install && \
    rm -rf ~/.bundle/ "${BUNDLE_PATH}"/ruby/*/cache "${BUNDLE_PATH}"/ruby/*/bundler/gems/*/.git

# Copy application code
COPY . .

# Precompile bootsnap code for faster boot times
RUN bundle exec bootsnap precompile app/ lib/

# Precompiling assets for production without requiring secret RAILS_MASTER_KEY
RUN SECRET_KEY_BASE_DUMMY=1 ./bin/rails assets:precompile

# Final stage for app image
FROM base

# Install packages needed for deployment
RUN apt-get update -qq && \
    apt-get install --no-install-recommends -y \
    curl \
    libpq5 && \
    rm -rf /var/lib/apt/lists /var/cache/apt/archives

# Copy built artifacts: gems, application
COPY --from=build /usr/local/bundle /usr/local/bundle
COPY --from=build /rails /rails

# Run and own only the runtime files as a non-root user for security
RUN useradd rails --create-home --shell /bin/bash && \
    chown -R rails:rails db log storage tmp
USER rails:rails

# Entrypoint prepares the database.
ENTRYPOINT ["/rails/bin/docker-entrypoint"]

# Start server via Thruster by default
EXPOSE 3000
CMD ["./bin/thrust", "./bin/rails", "server"]
```

## Docker Entrypoint

```bash
#!/bin/bash -e
# bin/docker-entrypoint

# Enable jemalloc for reduced memory usage and latency
if [ -z "${LD_PRELOAD+x}" ] && [ -f /usr/lib/*/libjemalloc.so.2 ]; then
  export LD_PRELOAD="$(echo /usr/lib/*/libjemalloc.so.2)"
fi

# If running the rails server then migrate existing database
if [ "${1}" == "./bin/rails" ] && [ "${2}" == "server" ]; then
  ./bin/rails db:prepare
fi

exec "${@}"
```

```bash
# Make entrypoint executable
chmod +x bin/docker-entrypoint
```

## Variations

### With Node.js (for JavaScript bundling)

```dockerfile
ARG RUBY_VERSION=3.3.0
ARG NODE_VERSION=20
FROM ruby:$RUBY_VERSION-slim AS base

WORKDIR /rails

ENV RAILS_ENV="production" \
    BUNDLE_DEPLOYMENT="1" \
    BUNDLE_PATH="/usr/local/bundle" \
    BUNDLE_WITHOUT="development:test"

FROM base AS build

# Install Node.js
RUN apt-get update -qq && \
    apt-get install --no-install-recommends -y \
    build-essential \
    curl \
    git \
    libpq-dev \
    pkg-config && \
    curl -fsSL https://deb.nodesource.com/setup_${NODE_VERSION}.x | bash - && \
    apt-get install --no-install-recommends -y nodejs && \
    npm install -g yarn

COPY Gemfile Gemfile.lock ./
RUN bundle install && \
    rm -rf ~/.bundle/ "${BUNDLE_PATH}"/ruby/*/cache

COPY package.json yarn.lock ./
RUN yarn install --frozen-lockfile

COPY . .

RUN bundle exec bootsnap precompile app/ lib/
RUN SECRET_KEY_BASE_DUMMY=1 ./bin/rails assets:precompile

FROM base

RUN apt-get update -qq && \
    apt-get install --no-install-recommends -y \
    curl \
    libpq5 && \
    rm -rf /var/lib/apt/lists /var/cache/apt/archives

COPY --from=build /usr/local/bundle /usr/local/bundle
COPY --from=build /rails /rails

RUN useradd rails --create-home --shell /bin/bash && \
    chown -R rails:rails db log storage tmp
USER rails:rails

ENTRYPOINT ["/rails/bin/docker-entrypoint"]
EXPOSE 3000
CMD ["./bin/thrust", "./bin/rails", "server"]
```

### With jemalloc (Memory Optimization)

```dockerfile
FROM base AS build

RUN apt-get update -qq && \
    apt-get install --no-install-recommends -y \
    build-essential \
    git \
    libjemalloc-dev \
    libpq-dev \
    pkg-config

# ... rest of build stage

FROM base

RUN apt-get update -qq && \
    apt-get install --no-install-recommends -y \
    curl \
    libjemalloc2 \
    libpq5 && \
    rm -rf /var/lib/apt/lists /var/cache/apt/archives

# ... rest of final stage
```

### Minimal Alpine Image

```dockerfile
ARG RUBY_VERSION=3.3.0
FROM ruby:$RUBY_VERSION-alpine AS base

WORKDIR /rails

ENV RAILS_ENV="production" \
    BUNDLE_DEPLOYMENT="1" \
    BUNDLE_PATH="/usr/local/bundle" \
    BUNDLE_WITHOUT="development:test"

FROM base AS build

RUN apk add --no-cache \
    build-base \
    git \
    postgresql-dev

COPY Gemfile Gemfile.lock ./
RUN bundle install && \
    rm -rf ~/.bundle/ "${BUNDLE_PATH}"/ruby/*/cache

COPY . .

RUN bundle exec bootsnap precompile app/ lib/
RUN SECRET_KEY_BASE_DUMMY=1 ./bin/rails assets:precompile

FROM base

RUN apk add --no-cache \
    curl \
    libpq \
    tzdata

COPY --from=build /usr/local/bundle /usr/local/bundle
COPY --from=build /rails /rails

RUN adduser -D rails && \
    chown -R rails:rails db log storage tmp
USER rails

ENTRYPOINT ["/rails/bin/docker-entrypoint"]
EXPOSE 3000
CMD ["./bin/thrust", "./bin/rails", "server"]
```

## .dockerignore

```dockerignore
# .dockerignore
.git
.gitignore
.dockerignore
Dockerfile*

# Ignore log files
log/*

# Ignore temp files
tmp/*

# Ignore storage files (Active Storage, etc.)
storage/*

# Ignore test files
test/
spec/
coverage/

# Ignore development files
.env*
!.env.example
.kamal/secrets*
config/master.key
config/credentials/*.key

# Ignore documentation
*.md
!README.md
docs/

# Ignore node modules (will be installed fresh)
node_modules/

# Ignore editor files
.vscode/
.idea/
*.swp
*.swo

# Ignore OS files
.DS_Store
Thumbs.db
```

## Build Commands

```bash
# Build image
docker build -t myapp:latest .

# Build with specific Ruby version
docker build --build-arg RUBY_VERSION=3.3.1 -t myapp:latest .

# Build for specific platform
docker build --platform linux/amd64 -t myapp:latest .

# Build with no cache (clean build)
docker build --no-cache -t myapp:latest .
```

## Anti-patterns

| Anti-pattern | Problem | Solution |
|--------------|---------|----------|
| Running as root | Security vulnerability | Use non-root user |
| Single stage | Large image size | Use multi-stage builds |
| Including dev gems | Bloated image | Use BUNDLE_WITHOUT |
| Missing .dockerignore | Slow builds, large context | Create .dockerignore |
| Hardcoded secrets | Security risk | Use ENV at runtime |

## Related Files

- [docker-compose.yml](./docker-compose.yml): Development environment
- [production.md](./production.md): Production optimizations
- [multi-stage.md](./multi-stage.md): Multi-stage patterns

## References

- [Docker Best Practices](https://docs.docker.com/develop/develop-images/dockerfile_best-practices/)
- [Rails Dockerfile Generator](https://github.com/rails/rails/blob/main/railties/lib/rails/generators/rails/app/templates/Dockerfile.tt)
