# Docker Compose Development Environment

## Overview

Docker Compose configuration for local Rails 8 development with PostgreSQL, Redis, and optional services like Mailcatcher and Minio.

## When to Use

- When setting up local development environment
- When team needs consistent environments
- When testing production-like configurations locally
- When running background jobs and caches locally

## Quick Start

### Basic Configuration

```yaml
# docker-compose.yml
services:
  web:
    build: .
    command: bash -c "rm -f tmp/pids/server.pid && bin/rails server -b 0.0.0.0"
    volumes:
      - .:/rails
      - bundle:/usr/local/bundle
    ports:
      - "3000:3000"
    environment:
      - DATABASE_URL=postgres://postgres:password@db:5432/myapp_development
      - REDIS_URL=redis://redis:6379/0
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_started

  db:
    image: postgres:16
    volumes:
      - postgres:/var/lib/postgresql/data
    environment:
      POSTGRES_PASSWORD: password
      POSTGRES_DB: myapp_development
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    volumes:
      - redis:/data
    ports:
      - "6379:6379"

volumes:
  bundle:
  postgres:
  redis:
```

## Full Development Stack

```yaml
# docker-compose.yml
services:
  # Rails Application
  web:
    build:
      context: .
      dockerfile: Dockerfile.dev
    command: bash -c "rm -f tmp/pids/server.pid && bin/dev"
    volumes:
      - .:/rails
      - bundle:/usr/local/bundle
      - node_modules:/rails/node_modules
    ports:
      - "3000:3000"
      - "3036:3036"  # Vite HMR
    environment:
      - DATABASE_URL=postgres://postgres:password@db:5432/myapp_development
      - REDIS_URL=redis://redis:6379/0
      - RAILS_ENV=development
      - WEBPACKER_DEV_SERVER_HOST=0.0.0.0
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_started
    stdin_open: true
    tty: true

  # Background Jobs (Solid Queue)
  jobs:
    build:
      context: .
      dockerfile: Dockerfile.dev
    command: bin/rails solid_queue:start
    volumes:
      - .:/rails
      - bundle:/usr/local/bundle
    environment:
      - DATABASE_URL=postgres://postgres:password@db:5432/myapp_development
      - REDIS_URL=redis://redis:6379/0
      - RAILS_ENV=development
    depends_on:
      - web
      - db

  # PostgreSQL Database
  db:
    image: postgres:16
    volumes:
      - postgres:/var/lib/postgresql/data
      - ./tmp/db-init:/docker-entrypoint-initdb.d
    environment:
      POSTGRES_PASSWORD: password
      POSTGRES_DB: myapp_development
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  # Redis (Cache, Sessions, Action Cable)
  redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes
    volumes:
      - redis:/data
    ports:
      - "6379:6379"

  # Email Testing
  mailcatcher:
    image: schickling/mailcatcher
    ports:
      - "1080:1080"  # Web UI
      - "1025:1025"  # SMTP

  # S3-compatible Storage (for Active Storage testing)
  minio:
    image: minio/minio
    command: server /data --console-address ":9001"
    volumes:
      - minio:/data
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    ports:
      - "9000:9000"   # API
      - "9001:9001"   # Console

volumes:
  bundle:
  postgres:
  redis:
  minio:
  node_modules:
```

## Development Dockerfile

```dockerfile
# Dockerfile.dev
ARG RUBY_VERSION=3.3.0
FROM ruby:$RUBY_VERSION

# Install dependencies
RUN apt-get update -qq && \
    apt-get install --no-install-recommends -y \
    build-essential \
    git \
    libpq-dev \
    curl \
    vim && \
    rm -rf /var/lib/apt/lists/*

# Install Node.js (for asset compilation)
RUN curl -fsSL https://deb.nodesource.com/setup_20.x | bash - && \
    apt-get install -y nodejs && \
    npm install -g yarn

WORKDIR /rails

# Install gems
COPY Gemfile Gemfile.lock ./
RUN bundle install

# Install JS packages
COPY package.json yarn.lock ./
RUN yarn install

COPY . .

EXPOSE 3000

CMD ["bin/rails", "server", "-b", "0.0.0.0"]
```

## Service Profiles

```yaml
# docker-compose.yml
services:
  web:
    # ... main config
    profiles: []  # Always runs

  jobs:
    # ... job worker config
    profiles: ["jobs"]  # Only with --profile jobs

  mailcatcher:
    # ... mail config
    profiles: ["mail"]

  minio:
    # ... storage config
    profiles: ["storage"]
```

```bash
# Run only web + db + redis
docker compose up

# Run with background jobs
docker compose --profile jobs up

# Run with mail testing
docker compose --profile mail up

# Run everything
docker compose --profile jobs --profile mail --profile storage up
```

## Common Commands

```bash
# Start all services
docker compose up

# Start in detached mode
docker compose up -d

# Rebuild and start
docker compose up --build

# View logs
docker compose logs -f web

# Run Rails commands
docker compose exec web bin/rails console
docker compose exec web bin/rails db:migrate
docker compose exec web bin/rails test

# Open shell in container
docker compose exec web bash

# Stop all services
docker compose down

# Stop and remove volumes (reset data)
docker compose down -v
```

## Database Configuration

```yaml
# config/database.yml
default: &default
  adapter: postgresql
  encoding: unicode
  pool: <%= ENV.fetch("RAILS_MAX_THREADS") { 5 } %>

development:
  <<: *default
  url: <%= ENV.fetch("DATABASE_URL", "postgres://postgres:password@localhost:5432/myapp_development") %>

test:
  <<: *default
  url: <%= ENV.fetch("TEST_DATABASE_URL", "postgres://postgres:password@localhost:5432/myapp_test") %>
```

## Email Configuration (Mailcatcher)

```ruby
# config/environments/development.rb
config.action_mailer.delivery_method = :smtp
config.action_mailer.smtp_settings = {
  address: ENV.fetch("SMTP_HOST", "localhost"),
  port: ENV.fetch("SMTP_PORT", 1025).to_i
}
config.action_mailer.default_url_options = { host: "localhost", port: 3000 }
```

## Minio (S3-compatible) Configuration

```yaml
# config/storage.yml
local:
  service: Disk
  root: <%= Rails.root.join("storage") %>

minio:
  service: S3
  endpoint: http://localhost:9000
  access_key_id: minioadmin
  secret_access_key: minioadmin
  bucket: myapp-development
  region: us-east-1
  force_path_style: true
```

```ruby
# config/environments/development.rb
config.active_storage.service = :minio
```

## Testing with Docker

```yaml
# docker-compose.test.yml
services:
  test:
    build:
      context: .
      dockerfile: Dockerfile.dev
    command: bin/rails test
    volumes:
      - .:/rails
      - bundle:/usr/local/bundle
    environment:
      - DATABASE_URL=postgres://postgres:password@db:5432/myapp_test
      - RAILS_ENV=test
    depends_on:
      db:
        condition: service_healthy

  db:
    image: postgres:16
    environment:
      POSTGRES_PASSWORD: password
      POSTGRES_DB: myapp_test
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

volumes:
  bundle:
```

```bash
# Run tests
docker compose -f docker-compose.test.yml run test
```

## Anti-patterns

| Anti-pattern | Problem | Solution |
|--------------|---------|----------|
| No volume for gems | Slow rebuilds | Mount bundle volume |
| No healthcheck | Race conditions | Add service healthchecks |
| Hardcoded secrets | Inflexible | Use environment variables |
| Missing .dockerignore | Slow builds | Create .dockerignore |
| No depends_on | Random failures | Define dependencies |

## Related Files

- [Dockerfile](./Dockerfile): Production Dockerfile
- [production.md](./production.md): Production config
- [../SKILL.md](../SKILL.md): Deploy overview

## References

- [Docker Compose Docs](https://docs.docker.com/compose/)
- [Rails Docker Guide](https://guides.rubyonrails.org/getting_started_with_devcontainer.html)
