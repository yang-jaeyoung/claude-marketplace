# AWS S3 Configuration

## Overview

Amazon S3 is the most widely used object storage service. This guide covers Rails Active Storage configuration, IAM policies, and production best practices.

## When to Use

- When using AWS infrastructure
- When needing proven reliability
- When advanced features (versioning, replication) are required
- When integrating with other AWS services

## Quick Start

### Gemfile

```ruby
# Gemfile
gem "aws-sdk-s3", require: false
```

### Storage Configuration

```yaml
# config/storage.yml
amazon:
  service: S3
  access_key_id: <%= Rails.application.credentials.dig(:aws, :access_key_id) %>
  secret_access_key: <%= Rails.application.credentials.dig(:aws, :secret_access_key) %>
  region: us-east-1
  bucket: myapp-production
```

```ruby
# config/environments/production.rb
config.active_storage.service = :amazon
```

### Credentials Setup

```bash
EDITOR="code --wait" bin/rails credentials:edit
```

```yaml
# config/credentials.yml.enc
aws:
  access_key_id: AKIAXXXXXXXXXXXXXXXX
  secret_access_key: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

## IAM Configuration

### Create IAM User

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "ActiveStorageAccess",
      "Effect": "Allow",
      "Action": [
        "s3:PutObject",
        "s3:GetObject",
        "s3:DeleteObject",
        "s3:ListBucket"
      ],
      "Resource": [
        "arn:aws:s3:::myapp-production",
        "arn:aws:s3:::myapp-production/*"
      ]
    }
  ]
}
```

### Minimal Policy (Read/Write)

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "s3:GetObject",
        "s3:PutObject",
        "s3:DeleteObject"
      ],
      "Resource": "arn:aws:s3:::myapp-production/*"
    }
  ]
}
```

### Policy with Direct Upload

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "s3:GetObject",
        "s3:PutObject",
        "s3:DeleteObject"
      ],
      "Resource": "arn:aws:s3:::myapp-production/*"
    },
    {
      "Effect": "Allow",
      "Action": "s3:ListBucket",
      "Resource": "arn:aws:s3:::myapp-production"
    }
  ]
}
```

## CORS Configuration

### Bucket CORS Policy

```json
{
  "CORSRules": [
    {
      "AllowedOrigins": ["https://myapp.com", "https://www.myapp.com"],
      "AllowedMethods": ["GET", "PUT", "HEAD"],
      "AllowedHeaders": ["*"],
      "ExposeHeaders": ["ETag", "Content-Type", "Content-MD5", "Content-Disposition"],
      "MaxAgeSeconds": 3600
    }
  ]
}
```

### AWS CLI Setup

```bash
# Create CORS configuration file
cat > cors.json << 'EOF'
{
  "CORSRules": [
    {
      "AllowedOrigins": ["https://myapp.com"],
      "AllowedMethods": ["GET", "PUT", "HEAD"],
      "AllowedHeaders": ["*"],
      "ExposeHeaders": ["ETag"],
      "MaxAgeSeconds": 3600
    }
  ]
}
EOF

# Apply CORS
aws s3api put-bucket-cors --bucket myapp-production --cors-configuration file://cors.json
```

## Bucket Configuration

### Create Bucket

```bash
# Create bucket
aws s3api create-bucket \
  --bucket myapp-production \
  --region us-east-1

# Enable versioning (optional)
aws s3api put-bucket-versioning \
  --bucket myapp-production \
  --versioning-configuration Status=Enabled
```

### Block Public Access

```bash
aws s3api put-public-access-block \
  --bucket myapp-production \
  --public-access-block-configuration \
    "BlockPublicAcls=true,IgnorePublicAcls=true,BlockPublicPolicy=true,RestrictPublicBuckets=true"
```

### Server-Side Encryption

```bash
aws s3api put-bucket-encryption \
  --bucket myapp-production \
  --server-side-encryption-configuration '{
    "Rules": [{
      "ApplyServerSideEncryptionByDefault": {
        "SSEAlgorithm": "AES256"
      }
    }]
  }'
```

## Multiple Environments

```yaml
# config/storage.yml
amazon_development:
  service: S3
  access_key_id: <%= Rails.application.credentials.dig(:aws, :access_key_id) %>
  secret_access_key: <%= Rails.application.credentials.dig(:aws, :secret_access_key) %>
  region: us-east-1
  bucket: myapp-development

amazon_staging:
  service: S3
  access_key_id: <%= Rails.application.credentials.dig(:aws, :access_key_id) %>
  secret_access_key: <%= Rails.application.credentials.dig(:aws, :secret_access_key) %>
  region: us-east-1
  bucket: myapp-staging

amazon_production:
  service: S3
  access_key_id: <%= Rails.application.credentials.dig(:aws, :access_key_id) %>
  secret_access_key: <%= Rails.application.credentials.dig(:aws, :secret_access_key) %>
  region: us-east-1
  bucket: myapp-production
```

```ruby
# config/environments/production.rb
config.active_storage.service = :amazon_production

# config/environments/staging.rb
config.active_storage.service = :amazon_staging
```

## CloudFront CDN

### Distribution Configuration

```yaml
# config/storage.yml
amazon:
  service: S3
  access_key_id: <%= Rails.application.credentials.dig(:aws, :access_key_id) %>
  secret_access_key: <%= Rails.application.credentials.dig(:aws, :secret_access_key) %>
  region: us-east-1
  bucket: myapp-production

amazon_cdn:
  service: S3
  access_key_id: <%= Rails.application.credentials.dig(:aws, :access_key_id) %>
  secret_access_key: <%= Rails.application.credentials.dig(:aws, :secret_access_key) %>
  region: us-east-1
  bucket: myapp-production
  public: true
```

### CloudFront Origin Access Identity

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "AWS": "arn:aws:iam::cloudfront:user/CloudFront Origin Access Identity EXXXXXXXXXX"
      },
      "Action": "s3:GetObject",
      "Resource": "arn:aws:s3:::myapp-production/*"
    }
  ]
}
```

### CDN URL Helper

```ruby
# app/helpers/cdn_helper.rb
module CdnHelper
  CDN_HOST = "https://d1234567890.cloudfront.net"

  def cdn_image_url(attachment)
    return nil unless attachment.attached?
    "#{CDN_HOST}/#{attachment.key}"
  end
end
```

## Presigned URLs

### Generate Presigned URL

```ruby
# Default 5-minute expiry
url = user.avatar.url

# Custom expiry
url = user.avatar.url(expires_in: 1.hour)

# For download
url = user.avatar.url(
  expires_in: 1.hour,
  disposition: "attachment",
  filename: "avatar.jpg"
)
```

### Direct Download

```ruby
# app/controllers/downloads_controller.rb
class DownloadsController < ApplicationController
  def show
    document = Document.find(params[:id])
    authorize document

    redirect_to document.file.url(
      expires_in: 30.seconds,
      disposition: :attachment
    ), allow_other_host: true
  end
end
```

## Lifecycle Rules

### Delete Old Uploads

```json
{
  "Rules": [
    {
      "ID": "DeleteUnattachedUploads",
      "Status": "Enabled",
      "Filter": {
        "Prefix": "tmp/"
      },
      "Expiration": {
        "Days": 1
      }
    },
    {
      "ID": "TransitionToGlacier",
      "Status": "Enabled",
      "Filter": {
        "Prefix": "archives/"
      },
      "Transitions": [
        {
          "Days": 90,
          "StorageClass": "GLACIER"
        }
      ]
    }
  ]
}
```

### Apply via CLI

```bash
aws s3api put-bucket-lifecycle-configuration \
  --bucket myapp-production \
  --lifecycle-configuration file://lifecycle.json
```

## Kamal Configuration

```yaml
# config/deploy.yml
env:
  secret:
    - AWS_ACCESS_KEY_ID
    - AWS_SECRET_ACCESS_KEY
    - AWS_REGION
    - S3_BUCKET
```

```yaml
# config/storage.yml
amazon:
  service: S3
  access_key_id: <%= ENV["AWS_ACCESS_KEY_ID"] %>
  secret_access_key: <%= ENV["AWS_SECRET_ACCESS_KEY"] %>
  region: <%= ENV.fetch("AWS_REGION", "us-east-1") %>
  bucket: <%= ENV["S3_BUCKET"] %>
```

## Backup Strategy

### Cross-Region Replication

```bash
# Enable versioning (required for replication)
aws s3api put-bucket-versioning \
  --bucket myapp-production \
  --versioning-configuration Status=Enabled

# Create replication rule
aws s3api put-bucket-replication \
  --bucket myapp-production \
  --replication-configuration file://replication.json
```

### Manual Backup

```bash
# Sync to backup bucket
aws s3 sync s3://myapp-production s3://myapp-backup --source-region us-east-1 --region us-west-2
```

## Monitoring

### CloudWatch Metrics

Enable S3 Request Metrics:
1. S3 Console > Bucket > Metrics
2. Create request metrics configuration

### Access Logs

```bash
aws s3api put-bucket-logging \
  --bucket myapp-production \
  --bucket-logging-status '{
    "LoggingEnabled": {
      "TargetBucket": "myapp-logs",
      "TargetPrefix": "s3-access/"
    }
  }'
```

## Anti-patterns

| Anti-pattern | Problem | Solution |
|--------------|---------|----------|
| Public bucket | Security risk | Block public access, use presigned URLs |
| Hardcoded credentials | Security risk | Use credentials file or environment |
| No encryption | Data exposure | Enable server-side encryption |
| No lifecycle rules | Storage costs | Configure lifecycle policies |
| Missing CORS | Direct uploads fail | Configure CORS |

## Related Files

- [active-storage.md](./active-storage.md): Active Storage config
- [cloudflare-r2.md](./cloudflare-r2.md): R2 configuration
- [../caching/cdn.md](../caching/cdn.md): CloudFront setup

## References

- [AWS S3 Documentation](https://docs.aws.amazon.com/s3/)
- [Rails Active Storage S3](https://guides.rubyonrails.org/active_storage_overview.html#amazon-s3-service)
- [S3 Security Best Practices](https://docs.aws.amazon.com/AmazonS3/latest/userguide/security-best-practices.html)
