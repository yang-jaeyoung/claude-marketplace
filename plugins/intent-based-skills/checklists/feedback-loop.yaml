# Feedback Loop - Verification Checklist
# 피드백 루프 시스템의 데이터 무결성 및 동작 검증

version: "1.0"
last_updated: "2025-01-20"

# ============================================================
# 사전 조건 검증 (피드백 기록 전)
# ============================================================
pre_execution:
  - id: PRE-001
    name: "스킬 존재 확인"
    description: "피드백을 기록할 스킬이 존재하는지 확인"
    validation: auto
    script: |
      #!/bin/bash
      SKILL_NAME="$1"
      if test -d "$SKILL_NAME" || test -f "index.yaml"; then
        echo "OK: Skill exists or index.yaml found"
      else
        echo "FAIL: Skill not found"
        exit 1
      fi
    priority: must
    error_action: abort

  - id: PRE-002
    name: "피드백 저장소 쓰기 가능"
    description: "피드백 데이터를 저장할 디렉토리에 쓰기 권한이 있는지 확인"
    validation: auto
    script: |
      #!/bin/bash
      FEEDBACK_DIR="${FEEDBACK_STORAGE:-.feedback}"
      if mkdir -p "$FEEDBACK_DIR" 2>/dev/null && test -w "$FEEDBACK_DIR"; then
        echo "OK: Feedback storage is writable"
      else
        echo "FAIL: Cannot write to feedback storage"
        exit 1
      fi
    priority: must
    error_action: abort

  - id: PRE-003
    name: "Python 사용 가능"
    description: "피드백 수집기 실행을 위한 Python 확인"
    validation: auto
    script: |
      #!/bin/bash
      if command -v python3 &> /dev/null || command -v python &> /dev/null; then
        echo "OK: Python available"
      else
        echo "FAIL: Python not found"
        exit 1
      fi
    priority: must
    error_action: abort

# ============================================================
# 피드백 데이터 검증 (피드백 기록 후)
# ============================================================
post_execution:

  # === 세션 데이터 검증 ===
  session:
    - id: SESSION-001
      name: "세션 ID 형식 유효성"
      description: "세션 ID가 유효한 UUID 형식인지 확인"
      validation: auto
      script: |
        #!/bin/bash
        SESSION_ID="$1"
        if echo "$SESSION_ID" | grep -qE "^[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}$"; then
          echo "OK: Valid session ID format"
        else
          echo "FAIL: Invalid session ID format"
          exit 1
        fi
      priority: must

    - id: SESSION-002
      name: "세션 로그 파일 존재"
      description: "세션 시작 후 로그 파일이 생성되었는지 확인"
      validation: auto
      script: |
        #!/bin/bash
        SKILL_NAME="$1"
        FEEDBACK_DIR="${FEEDBACK_STORAGE:-.feedback}"
        if test -d "$FEEDBACK_DIR/$SKILL_NAME/sessions"; then
          echo "OK: Session directory exists"
        else
          echo "FAIL: Session directory not found"
          exit 1
        fi
      priority: must

  # === 피드백 이벤트 검증 ===
  events:
    - id: EVENT-001
      name: "이벤트 JSON 유효성"
      description: "기록된 피드백 이벤트가 유효한 JSON 형식인지 확인"
      validation: auto
      script: |
        #!/bin/bash
        EVENT_FILE="$1"
        if test -f "$EVENT_FILE"; then
          python3 -c "import json; json.load(open('$EVENT_FILE'))" 2>/dev/null && \
            echo "OK: Valid JSON" || echo "FAIL: Invalid JSON"
        else
          echo "FAIL: Event file not found"
          exit 1
        fi
      priority: must

    - id: EVENT-002
      name: "필수 이벤트 필드 존재"
      description: "이벤트에 필수 필드(type, timestamp, skill, session_id)가 있는지 확인"
      validation: auto
      script: |
        python3 << 'EOF'
        import json
        import sys

        event_file = sys.argv[1] if len(sys.argv) > 1 else None
        if not event_file:
            print("FAIL: No event file specified")
            sys.exit(1)

        with open(event_file) as f:
            event = json.load(f)

        required = ['type', 'timestamp', 'skill']
        missing = [r for r in required if r not in event]

        if missing:
            print(f"FAIL: Missing required fields: {missing}")
            sys.exit(1)

        print("OK: All required fields present")
        EOF
      priority: must

    - id: EVENT-003
      name: "타임스탬프 형식 검증"
      description: "타임스탬프가 ISO 8601 형식인지 확인"
      validation: auto
      script: |
        #!/bin/bash
        TIMESTAMP="$1"
        if echo "$TIMESTAMP" | grep -qE "^[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2}"; then
          echo "OK: Valid ISO 8601 timestamp"
        else
          echo "FAIL: Invalid timestamp format"
          exit 1
        fi
      priority: should

  # === 분석 결과 검증 ===
  analysis:
    - id: ANALYSIS-001
      name: "분석 리포트 생성 가능"
      description: "피드백 데이터로 분석 리포트를 생성할 수 있는지 확인"
      validation: auto
      script: |
        #!/bin/bash
        SKILL_NAME="$1"
        FEEDBACK_DIR="${FEEDBACK_STORAGE:-.feedback}"
        if test -d "$FEEDBACK_DIR/$SKILL_NAME"; then
          echo "OK: Feedback data exists for analysis"
        else
          echo "WARNING: No feedback data for skill"
        fi
      priority: should

    - id: ANALYSIS-002
      name: "통계 계산 가능"
      description: "실행 완료 이벤트에서 통계를 계산할 수 있는지 확인"
      validation: auto
      script: |
        python3 << 'EOF'
        import json
        import os
        import sys

        skill_name = sys.argv[1] if len(sys.argv) > 1 else None
        feedback_dir = os.environ.get('FEEDBACK_STORAGE', '.feedback')
        skill_dir = os.path.join(feedback_dir, skill_name) if skill_name else None

        if not skill_dir or not os.path.isdir(skill_dir):
            print("WARNING: No feedback directory found")
            sys.exit(0)

        # 이벤트 파일 검색
        event_count = 0
        for root, dirs, files in os.walk(skill_dir):
            for f in files:
                if f.endswith('.json'):
                    event_count += 1

        if event_count > 0:
            print(f"OK: Found {event_count} event files for analysis")
        else:
            print("WARNING: No event files found")
        EOF
      priority: should

  # === 데이터 무결성 검증 ===
  integrity:
    - id: INTEG-001
      name: "세션-이벤트 연결성"
      description: "모든 이벤트가 유효한 세션에 연결되어 있는지 확인"
      validation: auto
      script: |
        python3 << 'EOF'
        import json
        import os
        import sys

        skill_name = sys.argv[1] if len(sys.argv) > 1 else None
        feedback_dir = os.environ.get('FEEDBACK_STORAGE', '.feedback')

        if not skill_name:
            print("OK: No skill specified, skipping")
            sys.exit(0)

        sessions_dir = os.path.join(feedback_dir, skill_name, 'sessions')
        if not os.path.isdir(sessions_dir):
            print("WARNING: Sessions directory not found")
            sys.exit(0)

        orphaned = 0
        for session_id in os.listdir(sessions_dir):
            session_path = os.path.join(sessions_dir, session_id)
            if os.path.isdir(session_path):
                events = [f for f in os.listdir(session_path) if f.endswith('.json')]
                if not events:
                    orphaned += 1

        if orphaned == 0:
            print("OK: All sessions have associated events")
        else:
            print(f"WARNING: {orphaned} sessions without events")
        EOF
      priority: should

    - id: INTEG-002
      name: "중복 세션 ID 검사"
      description: "동일한 세션 ID가 중복 사용되지 않았는지 확인"
      validation: auto
      script: |
        #!/bin/bash
        SKILL_NAME="$1"
        FEEDBACK_DIR="${FEEDBACK_STORAGE:-.feedback}"
        SESSIONS_DIR="$FEEDBACK_DIR/$SKILL_NAME/sessions"

        if test -d "$SESSIONS_DIR"; then
          TOTAL=$(ls -1 "$SESSIONS_DIR" 2>/dev/null | wc -l)
          UNIQUE=$(ls -1 "$SESSIONS_DIR" 2>/dev/null | sort -u | wc -l)
          if [ "$TOTAL" -eq "$UNIQUE" ]; then
            echo "OK: No duplicate session IDs"
          else
            echo "FAIL: Duplicate session IDs detected"
            exit 1
          fi
        else
          echo "OK: No sessions directory yet"
        fi
      priority: must

# ============================================================
# 통합 검증 리포트 템플릿
# ============================================================
report_template: |
  # Feedback Loop 검증 리포트

  **스킬**: {skill_name}
  **검증 시간**: {verified_at}
  **세션 수**: {session_count}

  ## 검증 요약

  | 카테고리 | 통과 | 실패 | 경고 |
  |---------|------|------|------|
  | 세션 데이터 | {session_pass} | {session_fail} | - |
  | 이벤트 검증 | {event_pass} | {event_fail} | - |
  | 분석 가능성 | {analysis_pass} | - | {analysis_warn} |
  | 데이터 무결성 | {integ_pass} | {integ_fail} | {integ_warn} |

  **전체 상태**: {overall_status}

  ## 피드백 통계

  - 총 실행 횟수: {total_executions}
  - 성공률: {success_rate}%
  - 평균 실행 시간: {avg_duration}초
  - 가장 많이 실패한 검증: {top_failures}

  ## 다음 단계

  {recommendations}
