# .NET Project Analyzer - Verification Checklist
# 분석 결과 검증 체크리스트

version: "1.0"

# ============================================================
# 사전 조건 검증 (PRE)
# ============================================================
pre_execution:
  - id: PRE-001
    name: "솔루션 파일 존재"
    description: "분석할 솔루션 파일(.sln 또는 .slnx)이 존재하는지 확인"
    validation: auto
    script: |
      test -f "$SOLUTION_PATH"
    error_message: "솔루션 파일을 찾을 수 없습니다: $SOLUTION_PATH"
    priority: must

  - id: PRE-002
    name: "유효한 솔루션 형식"
    description: "솔루션 파일이 .sln 또는 .slnx 형식인지 확인"
    validation: auto
    script: |
      echo "$SOLUTION_PATH" | grep -qE "\\.(sln|slnx)$"
    error_message: "지원하지 않는 솔루션 파일 형식입니다"
    priority: must

  - id: PRE-003
    name: "출력 디렉토리 쓰기 가능"
    description: "출력 디렉토리에 파일을 생성할 수 있는지 확인"
    validation: auto
    script: |
      mkdir -p "$OUTPUT_DIR" && test -w "$OUTPUT_DIR"
    error_message: "출력 디렉토리에 쓰기 권한이 없습니다"
    priority: must

  - id: PRE-004
    name: "dotnet CLI 사용 가능"
    description: "dotnet CLI가 설치되어 있는지 확인 (NuGet 업데이트 확인용)"
    validation: auto
    script: |
      command -v dotnet >/dev/null 2>&1
    error_message: "dotnet CLI가 설치되어 있지 않습니다 (선택적)"
    priority: should

# ============================================================
# 파일 존재 검증 (FILE)
# ============================================================
post_execution:
  files:
    - id: FILE-001
      name: "ARCHITECTURE.md 생성됨"
      description: "종합 아키텍처 문서가 생성되었는지 확인"
      validation: auto
      script: |
        test -f "$OUTPUT_DIR/ARCHITECTURE.md" && test -s "$OUTPUT_DIR/ARCHITECTURE.md"
      error_message: "ARCHITECTURE.md 파일이 생성되지 않았거나 비어있습니다"
      priority: must

    - id: FILE-002
      name: "analysis-data.json 생성됨"
      description: "분석 데이터 JSON 파일이 생성되었는지 확인"
      validation: auto
      script: |
        test -f "$OUTPUT_DIR/analysis-data.json" && test -s "$OUTPUT_DIR/analysis-data.json"
      error_message: "analysis-data.json 파일이 생성되지 않았거나 비어있습니다"
      priority: must

    - id: FILE-003
      name: "dependency-graph.mmd 생성됨"
      description: "의존성 그래프 다이어그램이 생성되었는지 확인"
      validation: auto
      script: |
        test -f "$OUTPUT_DIR/diagrams/dependency-graph.mmd"
      error_message: "dependency-graph.mmd 파일이 생성되지 않았습니다"
      priority: must

    - id: FILE-004
      name: "layer-architecture.mmd 생성됨"
      description: "레이어 아키텍처 다이어그램이 생성되었는지 확인"
      validation: auto
      script: |
        test -f "$OUTPUT_DIR/diagrams/layer-architecture.mmd"
      error_message: "layer-architecture.mmd 파일이 생성되지 않았습니다"
      priority: must

    - id: FILE-005
      name: "diagrams 디렉토리 존재"
      description: "다이어그램 디렉토리가 생성되었는지 확인"
      validation: auto
      script: |
        test -d "$OUTPUT_DIR/diagrams"
      error_message: "diagrams 디렉토리가 생성되지 않았습니다"
      priority: must

# ============================================================
# 유효성 검증 (VALID)
# ============================================================
  validity:
    - id: VALID-001
      name: "analysis-data.json 유효한 JSON"
      description: "분석 데이터가 유효한 JSON 형식인지 확인"
      validation: auto
      script: |
        python3 -c "import json; json.load(open('$OUTPUT_DIR/analysis-data.json'))" 2>/dev/null || \
        node -e "JSON.parse(require('fs').readFileSync('$OUTPUT_DIR/analysis-data.json'))" 2>/dev/null || \
        jq . "$OUTPUT_DIR/analysis-data.json" >/dev/null 2>&1
      error_message: "analysis-data.json이 유효한 JSON 형식이 아닙니다"
      priority: must

    - id: VALID-002
      name: "Mermaid 다이어그램 문법 유효"
      description: "의존성 그래프가 유효한 Mermaid 문법인지 확인"
      validation: auto
      script: |
        head -1 "$OUTPUT_DIR/diagrams/dependency-graph.mmd" | grep -qE "^(flowchart|graph|%%)"
      error_message: "dependency-graph.mmd가 유효한 Mermaid 형식이 아닙니다"
      priority: should

    - id: VALID-003
      name: "레이어 아키텍처 다이어그램 문법 유효"
      description: "레이어 아키텍처가 유효한 Mermaid 문법인지 확인"
      validation: auto
      script: |
        head -1 "$OUTPUT_DIR/diagrams/layer-architecture.mmd" | grep -qE "^(flowchart|graph|%%)"
      error_message: "layer-architecture.mmd가 유효한 Mermaid 형식이 아닙니다"
      priority: should

# ============================================================
# 내용 검증 (CONTENT)
# ============================================================
  content:
    - id: CONTENT-001
      name: "ARCHITECTURE.md 필수 섹션 포함"
      description: "아키텍처 문서에 필수 섹션이 모두 포함되었는지 확인"
      validation: auto
      script: |
        grep -q "## 개요\|## Overview" "$OUTPUT_DIR/ARCHITECTURE.md" && \
        grep -q "## 프로젝트 구조\|## Project Structure" "$OUTPUT_DIR/ARCHITECTURE.md" && \
        grep -q "## 의존성\|## Dependencies" "$OUTPUT_DIR/ARCHITECTURE.md"
      error_message: "ARCHITECTURE.md에 필수 섹션(개요, 프로젝트 구조, 의존성)이 누락되었습니다"
      priority: should

    - id: CONTENT-002
      name: "모든 프로젝트 포함"
      description: "솔루션의 모든 프로젝트가 분석에 포함되었는지 확인"
      validation: auto
      script: |
        # 솔루션의 프로젝트 수와 분석된 프로젝트 수 비교
        EXPECTED=$(grep -c "\.csproj" "$SOLUTION_PATH" 2>/dev/null || echo "0")
        ACTUAL=$(python3 -c "import json; print(len(json.load(open('$OUTPUT_DIR/analysis-data.json'))['projects']))" 2>/dev/null || echo "0")
        test "$ACTUAL" -ge "$EXPECTED"
      error_message: "일부 프로젝트가 분석에서 누락되었습니다"
      priority: should

    - id: CONTENT-003
      name: "레이어 분류 완료"
      description: "모든 프로젝트가 레이어로 분류되었는지 확인"
      validation: auto
      script: |
        UNCLASSIFIED=$(python3 -c "import json; data = json.load(open('$OUTPUT_DIR/analysis-data.json')); unclassified = [p['name'] for p in data.get('projects', []) if p.get('layer') == 'Unclassified']; print(len(unclassified))" 2>/dev/null || echo "999")
        test "$UNCLASSIFIED" -eq "0"
      error_message: "일부 프로젝트가 레이어로 분류되지 않았습니다"
      priority: should

    - id: CONTENT-004
      name: "의존성 그래프에 모든 참조 포함"
      description: "의존성 그래프에 모든 프로젝트 참조가 포함되었는지 확인"
      validation: auto
      script: |
        # 노드 개수 확인 (기본적인 검증)
        NODE_COUNT=$(grep -c "subgraph\|-->" "$OUTPUT_DIR/diagrams/dependency-graph.mmd" 2>/dev/null || echo "0")
        test "$NODE_COUNT" -gt "0"
      error_message: "의존성 그래프가 불완전합니다"
      priority: should

    - id: CONTENT-005
      name: "메타데이터 포함"
      description: "analysis-data.json에 메타데이터가 포함되었는지 확인"
      validation: auto
      script: |
        python3 -c "import json; data = json.load(open('$OUTPUT_DIR/analysis-data.json')); assert 'meta' in data; assert 'generated_at' in data['meta']; assert 'skill_version' in data['meta']" 2>/dev/null
      error_message: "분석 데이터에 메타데이터가 누락되었습니다"
      priority: should

# ============================================================
# 정확성 검증 (ACCURACY) - 수동 확인 필요
# ============================================================
  accuracy:
    - id: ACCURACY-001
      name: "레이어 분류 정확성"
      description: "프로젝트가 실제 아키텍처에 맞게 레이어로 분류되었는지 확인"
      validation: manual
      guidance: |
        다음을 확인하세요:
        1. Domain 레이어: 핵심 엔티티, 인터페이스만 포함
        2. Application 레이어: 유스케이스, 서비스 로직 포함
        3. Infrastructure 레이어: DB, 외부 서비스 구현 포함
        4. Presentation 레이어: API, UI 컨트롤러 포함
        5. Contracts 레이어: 공유 DTO 포함
      priority: should

    - id: ACCURACY-002
      name: "의존성 방향 위반 정확성"
      description: "감지된 아키텍처 위반이 실제 위반인지 확인"
      validation: manual
      guidance: |
        analysis-data.json의 violations 배열을 확인하세요:
        1. Domain이 다른 레이어를 참조하면 Critical 위반
        2. Application이 Infrastructure를 직접 참조하면 Warning
        3. 순환 참조는 항상 Critical

        오탐(False Positive) 여부를 확인하세요.
      priority: should

    - id: ACCURACY-003
      name: "NuGet 버전 불일치 정확성"
      description: "감지된 NuGet 버전 불일치가 정확한지 확인"
      validation: manual
      guidance: |
        다음을 확인하세요:
        1. 동일 패키지의 다른 버전이 사용되는 경우가 맞는지
        2. 버전 불일치가 의도적인지 (예: 테스트 프로젝트)
        3. 누락된 버전 불일치가 있는지
      priority: could

    - id: ACCURACY-004
      name: "CQRS 패턴 감지 정확성"
      description: "CQRS 패턴 사용 여부가 정확히 감지되었는지 확인"
      validation: manual
      guidance: |
        다음 패턴이 존재하면 CQRS 사용:
        - IQueryRepository / ICommandRepository 분리
        - Dapper(Query) + EF Core(Command) 조합
        - QueryHandler / CommandHandler 패턴

        cqrs_detected 값이 실제와 일치하는지 확인하세요.
      priority: could

  # 문서화 검증 (DOC)
  documentation:
    - id: DOC-001
      name: "ARCHITECTURE.md 문서화 완성도"
      description: "필수 섹션이 모두 포함되고 내용이 충분한지 확인"
      validation: manual
      priority: should

    - id: DOC-003
      name: "문서화 확인"
      description: "생성된 문서가 프로젝트 실제 구조와 일치하는지 확인"
      validation: manual
      priority: must
      guidance: |
        다음을 확인하세요:
        1. 모든 프로젝트가 문서에 포함됨
        2. 레이어 분류가 실제와 일치
        3. 의존성 관계가 정확히 기술됨

  # 테스트/검토 검증 (TEST)
  testing:
    - id: TEST-004
      name: "테스트 실행"
      description: "생성된 문서/데이터로 실제 프로젝트 이해 가능한지 확인"
      validation: manual
      priority: must
      guidance: |
        다음을 확인하세요:
        1. 새로운 개발자가 문서만으로 프로젝트 구조 파악 가능
        2. 의존성 그래프가 실제 빌드 순서와 일치
        3. 위반 사항이 실제 문제점을 반영

# ============================================================
# 요약
# ============================================================
summary:
  must_count: 10
  should_count: 10
  could_count: 2

  categories:
    - name: "사전 조건 (PRE)"
      count: 4
    - name: "파일 존재 (FILE)"
      count: 5
    - name: "유효성 (VALID)"
      count: 3
    - name: "내용 (CONTENT)"
      count: 5
    - name: "정확성 (ACCURACY)"
      count: 4
    - name: "문서화 (DOC)"
      count: 2
    - name: "테스트 (TEST)"
      count: 1
